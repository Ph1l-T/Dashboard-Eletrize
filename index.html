<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eletrize</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="icon" href="images/pwa/app-icon-192.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1C1C1C">
    <link rel="apple-touch-icon" href="images/pwa/app-icon-192.png">
    <link rel="stylesheet" href="styles.css?v=1737455925">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script>
        // Cache busting din√¢mico para mobile - for√ßa reload de assets
        (function() {
            var timestamp = new Date().getTime();
            var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Para mobile, adicionar timestamp mais agressivo
                var cacheBuster = timestamp + '_' + Math.random().toString(36).substr(2, 9);
                console.log('üì± Mobile detectado - cache buster:', cacheBuster);
                
                // Atualizar localStorage com nova vers√£o
                try {
                    localStorage.setItem('app_cache_version', cacheBuster);
                    localStorage.setItem('last_mobile_load', timestamp);
                } catch(e) {
                    console.warn('localStorage indispon√≠vel para cache busting');
                }
            }
        })();
    </script>
    <style>
        /* Bot√£o invis√≠vel no card para capturar clique na Home */
        .room-card-link{position:absolute;left:0;top:0;width:100%;height:100%;z-index:10;background:transparent;border:none;cursor:pointer}
    </style>
    </head>
<body>

    <!-- Tela de Loading Global -->
    <div id="global-loader" class="global-loader">
        <div class="loader-content">
            <div class="loader-logo">
                <img src="images/icons/Eletrize.svg" alt="Eletrize" width="80" height="80">
            </div>
            <div class="loader-spinner"></div>
            <div class="loader-text">Carregando estados dos dispositivos...</div>
            <div class="loader-progress">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
                <div id="progress-text" class="progress-text">0%</div>
            </div>
        </div>
    </div>

    <!-- SPA root -->
    <div id="spa-root"></div>

    <!-- Confirmation Popup -->
    <div class="popup-overlay" id="confirmation-popup">
        <div class="popup-dialog">
            <p class="popup-message" id="popup-message"></p>
            <div class="popup-buttons">
                <button class="popup-btn cancel" id="popup-cancel">Cancelar</button>
                <button class="popup-btn confirm" id="popup-confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Navbar fixa SPA -->
    <nav class="navbar" id="spa-navbar">
        <div class="nav-item" data-page="home">
            <div class="nav-icon-wrapper">
                <img src="images/icons/icon-home.svg" alt="Home" class="nav-icon">
            </div>
        </div>
        <div class="nav-item" data-page="scenes">
            <div class="nav-icon-wrapper">
                <img src="images/icons/icon-scenes.svg" alt="Cen√°rios" class="nav-icon">
            </div>
        </div>
    </nav>

    <script>
        // Carregamento din√¢mico com cache busting agressivo para mobile
        (function() {
            var baseVersion = '1737455925';
            var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            var cacheBuster = baseVersion;
            
            if (isMobile) {
                // Cache busting extra agressivo para mobile
                cacheBuster = baseVersion + '_' + new Date().getTime() + '_' + Math.random().toString(36).substr(2, 5);
                console.log('üì± Mobile: cache busting agressivo -', cacheBuster);
            }
            
            // Carregar script.js
            var scriptMain = document.createElement('script');
            scriptMain.src = 'script.js?v=' + cacheBuster;
            document.head.appendChild(scriptMain);
            
            // Carregar scenes.js
            var scriptScenes = document.createElement('script');
            scriptScenes.src = 'scenes.js?v=' + cacheBuster;
            document.head.appendChild(scriptScenes);
        })();
    </script>
    <script>
    // PWA: registra service worker (desativado em localhost para evitar cache no desenvolvimento)
    if ('serviceWorker' in navigator) {
        const isLocalhost = ['localhost', '127.0.0.1', '::1'].includes(location.hostname);
        if (isLocalhost) {
            // Em ambiente de desenvolvimento, garantir remo√ß√£o do SW e dos caches
            navigator.serviceWorker.getRegistrations?.().then(regs => regs.forEach(r => r.unregister())).catch(()=>{});
            if (window.caches?.keys) {
                caches.keys().then(keys => Promise.all(keys.map(k => caches.delete(k)))).catch(()=>{});
            }
        } else {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js').catch(()=>{});
            });
        }
    }
    // --- SPA Core ---
    const spaRoot = document.getElementById('spa-root');

    // Fotos dos cards por rota (reaproveitadas como fundo das p√°ginas internas)
    const ROOM_PHOTOS = {
        cafe: 'images/Images/photo-sinuca.jpg',
        piscina: 'images/Images/photo-piscina.jpg',
        gourmet: 'images/Images/photo-gourmet.jpg',
        'home-ambiente': 'images/Images/photo-home.jpg',
        recepcao: 'images/Images/Photo-Recepcao.jpg'
    };

    const pages = {
        curtains: () => `
            <div class="top-bar-custom"></div>
            <main class="container">
                <div class="page active">
                    <h1 class="page-title fixed-header" style="display:flex;justify-content:center;align-items:center;">
                        <img src="images/icons/Eletrize.svg" alt="Vila Estampa" />
                    </h1>
                    <div class="under-construction">Em constru√ß√£o</div>
                    
                    <div class="rooms-frame" style="padding: 20px;">
                        <!-- Garden -->
                        <div class="curtain-section">
                            <h2 class="section-title">Garden</h2>
                            <div class="section-divider"></div>
                            
                            <div class="curtain-controls-wrapper">
                                <div class="room-control curtain-control" data-device-id="42" data-no-sync="true">
                                    <div class="room-control-label">Cortina Esquerda</div>
                                    <div class="curtain-actions">
                                        <button class="curtain-btn open" data-device-id="42" onclick="curtainAction(this, 'open')"><img src="images/icons/icon-up.svg" alt="Abrir"></button>
                                        <button class="curtain-btn stop" data-device-id="42" onclick="curtainAction(this, 'stop')"><img src="images/icons/icon-stop.svg" alt="Parar"></button>
                                        <button class="curtain-btn close" data-device-id="42" onclick="curtainAction(this, 'close')"><img src="images/icons/icon-down.svg" alt="Fechar"></button>
                                    </div>
                                </div>
                                
                                <div class="room-control curtain-control" data-device-id="43" data-no-sync="true">
                                    <div class="room-control-label">Cortina Direita</div>
                                    <div class="curtain-actions">
                                        <button class="curtain-btn open" data-device-id="43" onclick="curtainAction(this, 'open')"><img src="images/icons/icon-up.svg" alt="Abrir"></button>
                                        <button class="curtain-btn stop" data-device-id="43" onclick="curtainAction(this, 'stop')"><img src="images/icons/icon-stop.svg" alt="Parar"></button>
                                        <button class="curtain-btn close" data-device-id="43" onclick="curtainAction(this, 'close')"><img src="images/icons/icon-down.svg" alt="Fechar"></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Reuni√£o -->
                        <div class="curtain-section">
                            <h2 class="section-title">Reuni√£o</h2>
                            <div class="section-divider"></div>
                            
                            <div class="curtain-controls-wrapper">
                                <div class="room-control curtain-control" data-device-id="39" data-no-sync="true">
                                    <div class="room-control-label">Cortina Interna</div>
                                    <div class="curtain-actions">
                                        <button class="curtain-btn open" data-device-id="39" onclick="curtainAction(this, 'open')"><img src="images/icons/icon-up.svg" alt="Abrir"></button>
                                        <button class="curtain-btn stop" data-device-id="39" onclick="curtainAction(this, 'stop')"><img src="images/icons/icon-stop.svg" alt="Parar"></button>
                                        <button class="curtain-btn close" data-device-id="39" onclick="curtainAction(this, 'close')"><img src="images/icons/icon-down.svg" alt="Fechar"></button>
                                    </div>
                                </div>
                                
                                <div class="room-control curtain-control" data-device-id="40" data-no-sync="true">
                                    <div class="room-control-label">Cortina Externa</div>
                                    <div class="curtain-actions">
                                        <button class="curtain-btn open" data-device-id="40" onclick="curtainAction(this, 'open')"><img src="images/icons/icon-up.svg" alt="Abrir"></button>
                                        <button class="curtain-btn stop" data-device-id="40" onclick="curtainAction(this, 'stop')"><img src="images/icons/icon-stop.svg" alt="Parar"></button>
                                        <button class="curtain-btn close" data-device-id="40" onclick="curtainAction(this, 'close')"><img src="images/icons/icon-down.svg" alt="Fechar"></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Caf√© -->
                        <div class="curtain-section">
                            <h2 class="section-title">Caf√©</h2>
                            <div class="section-divider"></div>
                            
                            <div class="curtain-controls-wrapper">
                                <div class="room-control curtain-control" data-device-id="38" data-no-sync="true">
                                    <div class="room-control-label">Cortina Caf√©</div>
                                    <div class="curtain-actions">
                                        <button class="curtain-btn open" data-device-id="38" onclick="curtainAction(this, 'open')"><img src="images/icons/icon-up.svg" alt="Abrir"></button>
                                        <button class="curtain-btn stop" data-device-id="38" onclick="curtainAction(this, 'stop')"><img src="images/icons/icon-stop.svg" alt="Parar"></button>
                                        <button class="curtain-btn close" data-device-id="38" onclick="curtainAction(this, 'close')"><img src="images/icons/icon-down.svg" alt="Fechar"></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        `,
        scenes: () => `
            <div class="top-bar-custom"></div>
             <main class="container">
                <div class="page active">
                    <h1 class="page-title fixed-header" style="display:flex;justify-content:center;align-items:center;">
                        <img src="images/icons/Eletrize.svg" alt="Vila Estampa" />
                    </h1>
                    <div class="controls-grid" style="top: 130px; grid-template-columns: 1fr; grid-auto-rows: min-content; gap: 15px;">
                        <div class="control-card large scene-control-card" id="master-light-toggle-btn" onclick="handleMasterLightToggle()">
                            <img class="control-icon" id="master-light-toggle-icon" src="images/icons/icon-small-light-off.svg" alt="Master Light Toggle">
                            <div class="control-label" id="master-light-toggle-label">Ligar Tudo</div>
                        </div>
                    </div>
                </div>
            </main>
        `,
        home: () => `
            <div class="top-bar-custom"></div>
            <main class="container">
                <div class="page active" id="home-page">
                    <h1 class="page-title fixed-header" style="display:flex;justify-content:center;align-items:center;">
                        <img src="images/icons/Eletrize.svg" alt="Vila Estampa" />
                    </h1>
                    <div class="rooms-frame">
                        <div class="rooms-list"></div>
                    </div>
                </div>
            </main>
        `,

        entrada: () => `
<div class="top-bar-custom"></div>
<div class="page active page-container">
    <div class="page-header">
        <button class="back-btn" onclick="spaNavigate('home')"><img src="images/icons/back.svg" alt="Voltar"></button>
        <h1 class="page-title">Escrit√≥rio</h1>
    </div>
    <div class="room-controls-list">
        <div class="room-control" data-state="off" data-device-id="231" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Pendente</div>
        </div>
        <div class="room-control" data-state="off" data-device-id="232" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Trilho</div>
        </div>
        <div class="room-control" data-state="off" data-device-id="233" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Lustre</div>
        </div>
        <div class="room-control" data-state="off" data-device-id="234" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Balizador</div>
        </div>
        <div class="room-control" data-state="off" data-device-id="235" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Banheiro</div>
        </div>
    </div>
</div>
        `,

        vitrine: () => `
<div class="top-bar-custom"></div>
<div class="page active page-container">
    <div class="page-header">
        <button class="back-btn" onclick="spaNavigate('home')"><img src="images/icons/back.svg" alt="Voltar"></button>
        <h1 class="page-title">Projetos</h1>
    </div>
    <div class="room-controls-list">
        <div class="room-control" data-state="off" data-device-id="236" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="https://cdn.jsdelivr.net/gh/Ph1l-T/My-Dashboard-Hubitat@main/images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Ilumina√ß√£o</div>
        </div>
        <div class="room-control" data-state="off" data-device-id="237" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="https://cdn.jsdelivr.net/gh/Ph1l-T/My-Dashboard-Hubitat@main/images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Lustre</div>
        </div>
    </div>
</div>
        `,

        garden: () => `
<div class="top-bar-custom"></div>
<div class="page active page-container">
    <div class="page-header">
        <button class="back-btn" onclick="spaNavigate('home')"><img src="images/icons/back.svg" alt="Voltar"></button>
        <h1 class="page-title">Programa√ß√£o</h1>
    </div>
    <div class="room-controls-list">
        <div class="room-control" data-state="off" data-device-id="238" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Lustre</div>
        </div>
        <div class="room-control" data-state="off" data-device-id="239" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Rack</div>
        </div>
        <div class="room-control" data-state="off" data-device-id="240" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Arm√°rio</div>
        </div>
    </div>
</div>
        `,

        reuniao: () => `
<div class="top-bar-custom"></div>
<div class="page active page-container">
    <div class="page-header">
        <button class="back-btn" onclick="spaNavigate('home')"><img src="images/icons/back.svg" alt="Voltar"></button>
        <h1 class="page-title">Eletrize Solar</h1>
    </div>
    <div class="room-controls-list">
        <div class="room-control" data-state="off" data-device-id="248" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Ilumina√ß√£o</div>
        </div>
        <div class="room-control" data-state="off" data-device-id="249" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Arm√°rio</div>
        </div>
        
        <div class="room-control" data-state="off" data-device-id="250" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Jardim</div>
        </div>
    </div>
</div>
        `,

        cafe: () => `
<div class="top-bar-custom"></div>
<div class="page active page-container" style="background-image:url('images/Images/Photo-cafe.jpg')">
    <div class="page-header">
        <button class="back-btn" onclick="spaNavigate('home')"><img src="images/icons/back.svg" alt="Voltar"></button>
        <h1 class="page-title">Sinuca</h1>
    </div>
    <div class="room-controls-list">
        <div class="room-control" data-state="off" data-device-id="241" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Spot</div>
        </div>
        <div class="room-control" data-state="off" data-device-id="242" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Bar</div>
        </div>
        <div class="room-control" data-state="off" data-device-id="243" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Balizadores</div>
        </div>
        <div class="room-control" data-state="off" data-device-id="244" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Trilhos</div>
        </div>
    </div>
</div>
        `,

        gourmet: () => `
<div class="top-bar-custom"></div>
<div class="page active page-container">
    <div class="page-header">
        <button class="back-btn" onclick="spaNavigate('home')"><img src="images/icons/back.svg" alt="Voltar"></button>
        <h1 class="page-title">Gourmet</h1>
    </div>
    <div class="room-controls-list">
        <div class="room-control" data-state="off" data-device-id="251" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Ilumina√ß√£o</div>
        </div>
        <div class="room-control" data-state="off" data-device-id="252" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Abajur</div>
        </div>
    </div>
</div>
        `,

        'home-ambiente': () => `
<div class="top-bar-custom"></div>
<div class="page active page-container">
    <div class="page-header">
        <button class="back-btn" onclick="spaNavigate('home')"><img src="images/icons/back.svg" alt="Voltar"></button>
        <h1 class="page-title">Home</h1>
    </div>
    <div class="room-controls-list">
        <div class="room-control" data-state="off" data-device-id="253" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Ilumina√ß√£o</div>
        </div>
    </div>
</div>
        `,

        recepcao: () => `
<div class="top-bar-custom"></div>
<div class="page active page-container">
    <div class="page-header">
        <button class="back-btn" onclick="spaNavigate('home')"><img src="images/icons/back.svg" alt="Voltar"></button>
        <h1 class="page-title">Recep√ß√£o</h1>
    </div>
    <div class="room-controls-list">
        <div class="room-control" data-state="off" data-device-id="261" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Lustre</div>
        </div>
        <div class="room-control" data-state="off" data-device-id="262" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Lavabo</div>
        </div>
        <div class="room-control" data-state="off" data-device-id="263" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Jardim Externo</div>
        </div>
    </div>
</div>
        `,

        cinema: () => `
<div class="top-bar-custom"></div>
<div class="page active page-container">
    <div class="page-header">
        <button class="back-btn" onclick="spaNavigate('home')"><img src="images/icons/back.svg" alt="Voltar"></button>
        <h1 class="page-title">Cinema</h1>
    </div>
    <div class="room-controls-list">
        <div class="room-control" data-state="off" data-device-id="259" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Ilumina√ß√£o</div>
        </div>
        <div class="room-control" data-state="off" data-device-id="260" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Balizadores</div>
        </div>
    </div>
</div>
        `,

        piscina: () => `
<div class="top-bar-custom"></div>
<div class="page active page-container">
    <div class="page-header">
        <button class="back-btn" onclick="spaNavigate('home')"><img src="images/icons/back.svg" alt="Voltar"></button>
        <h1 class="page-title">Piscina</h1>
    </div>
    <div class="room-controls-list">
        <div class="room-control" data-state="off" data-device-id="246" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Ilumina√ß√£o</div>
        </div>
        <div class="room-control" data-state="off" data-device-id="245" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Jardim</div>
        </div>
    </div>
</div>
        `,

        externo: () => `
<div class="top-bar-custom"></div>
<div class="page active page-container">
    <div class="page-header">
        <button class="back-btn" onclick="spaNavigate('home')"><img src="images/icons/back.svg" alt="Voltar"></button>
        <h1 class="page-title">Externo</h1>
    </div>
    <div class="room-controls-list">
        <div class="room-control" data-state="off" data-device-id="256" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Jardim</div>
        </div>
        <div class="room-control" data-state="off" data-device-id="257" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Fachada</div>
        </div>
    </div>
</div>
        `,

        refeitorio: () => `
<div class="top-bar-custom"></div>
<div class="page active page-container">
    <div class="page-header">
        <button class="back-btn" onclick="spaNavigate('home')"><img src="images/icons/back.svg" alt="Voltar"></button>
        <h1 class="page-title">Refeit√≥rio</h1>
    </div>
    <div class="room-controls-list">
        <div class="room-control" data-state="off" data-device-id="258" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Cozinha</div>
        </div>
        <div class="room-control" data-state="off" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Ferramentas</div>
        </div>
        <div class="room-control" data-state="off" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Banheiro</div>
        </div>
        <div class="room-control" data-state="off" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Pain√©is</div>
        </div>
    </div>
</div>
        `,

        funcionarios: () => `
<div class="top-bar-custom"></div>
<div class="page active page-container">
    <div class="page-header">
        <button class="back-btn" onclick="spaNavigate('home')"><img src="images/icons/back.svg" alt="Voltar"></button>
        <h1 class="page-title">Funcion√°rios</h1>
    </div>
    <div class="room-controls-list">
        <div class="room-control" data-state="off" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Cozinha</div>
        </div>
        <div class="room-control" data-state="off" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Ferramentas</div>
        </div>
        <div class="room-control" data-state="off" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Luz Vermelha</div>
        </div>
        <div class="room-control" data-state="off" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Banheiro</div>
        </div>
        <div class="room-control" data-state="off" onclick="toggleRoomControl(this)">
            <img class="room-control-icon" src="images/icons/icon-small-light-off.svg" alt="Luz">
            <div class="room-control-label">Pain√©is</div>
        </div>
    </div>
</div>
        `,

        garagem: () => `
<div class="top-bar-custom"></div>
<div class="page active page-container">
    <div class="page-header">
        <button class="back-btn" onclick="spaNavigate('home')"><img src="images/icons/back.svg" alt="Voltar"></button>
        <h1 class="page-title">Garagem</h1>
    </div>
    <div class="room-controls-list">
        <div style="color:#bbb; text-align:center; width: 100%;">Sem bot√µes ainda.</div>
    </div>
</div>
        `
    };

    function spaNavigate(page) {
        window.location.hash = page;
    }

    function renderSpa() {
        let page = window.location.hash.replace('#', '') || 'home';
        if (!pages[page]) page = 'home';
        spaRoot.innerHTML = pages[page]();

        // Constr√≥i a lista de c√¥modos na Home
        if (page === 'home') {
            const rooms = [
                { name: 'Escrit√≥rio', route: 'entrada' },
                { name: 'Projetos', route: 'vitrine' },
                { name: 'Programa√ß√£o', route: 'garden' },
                { name: 'Sinuca', route: 'cafe' },
                { name: 'Eletrize Solar', route: 'reuniao' },
                { name: 'Gourmet', route: 'gourmet' },
                { name: 'Home', route: 'home-ambiente' },
                { name: 'Recep√ß√£o', route: 'recepcao' },
                { name: 'Cinema', route: 'cinema' },
                { name: 'Piscina', route: 'piscina' },
                { name: 'Externo', route: 'externo' },
                { name: 'Refeit√≥rio', route: 'refeitorio' },
                { name: 'Funcion√°rios', route: 'funcionarios' },
            ];
            const list = document.querySelector('.rooms-list');
            if (list) {
                const order = ['entrada','vitrine','garden','cafe','reuniao','piscina','gourmet','home-ambiente','funcionarios','cinema','recepcao'];
                const visible = rooms
                    .filter(r => order.includes(r.route))
                    .sort((a, b) => order.indexOf(a.route) - order.indexOf(b.route));
                const photoMap = ROOM_PHOTOS;
                const roomDevices = {
                    'entrada': ['231','232','233','234','235'],
                    'vitrine': ['236','237'],
                    'garden': ['238','239','240'],
                    'cafe': ['241','242','243','244'],
                    'reuniao': ['248','249','250'],
                    'gourmet': ['251','252'],
                    'home-ambiente': ['253'],
                    'funcionarios': ['254','255','256','257','258'],
                    'cinema': ['259','260'],
                    'recepcao': ['261','262','263'],
                    'piscina': ['246','245']
                };
                list.innerHTML = visible.map(r => {
                    const hasPhoto = Boolean(photoMap[r.route]);
                    const ids = roomDevices[r.route] || [];
                    return `
                    <div class="room-card ${hasPhoto ? 'has-photo' : ''}">
                        ${hasPhoto ? `<img src="${photoMap[r.route]}" alt="${r.name}">` : ''}
                        <span>${r.name}</span>
                        <button class="room-master-btn" data-route="${r.route}" data-device-ids="${(ids||[]).join(',')}" onclick="onHomeMasterClick(event,this)" aria-label="Master"><img class="room-master-icon" src="images/icons/icon-small-light-off.svg" alt="Master"></button>
                        <button class="room-card-link" onclick="spaNavigate('${r.route}')"></button>
                    </div>`;
                }).join('');
                if (typeof initHomeMasters === 'function') initHomeMasters();
            }
        }

        // Define o fundo da p√°gina interna com a mesma foto do card
        (function setPageBackground(route){
            const url = ROOM_PHOTOS[route];
            if (!url) return;
            const container = document.querySelector('.page.active .page-container') || document.querySelector('.page.active.page-container');
            if (container) {
                container.style.backgroundImage = `url('${url}')`;
                container.style.backgroundSize = 'cover';
                container.style.backgroundPosition = 'center';
            }
        })(page);

        // Atualiza navbar (ativo + indicador)
        const nav = document.getElementById('spa-navbar');
        const items = nav.querySelectorAll('.nav-item');
        const navPages = Array.from(items).map(i => i.getAttribute('data-page'));
        const navPage = navPages.includes(page) ? page : 'home';
        let activeIndex = navPages.indexOf(navPage);
        if (activeIndex < 0) activeIndex = navPages.indexOf('home');
        items.forEach((item, idx) => item.classList.toggle('active', idx === activeIndex));
        const activeItem = items[activeIndex];
        if (activeItem) {
            const navRect = nav.getBoundingClientRect();
            const itemRect = activeItem.getBoundingClientRect();
            const center = itemRect.left + itemRect.width / 2 - navRect.left;
            nav.style.setProperty('--indicator-left', `${center}px`);
        }

        // Inicializa bot√µes dos c√¥modos nas p√°ginas internas
        if (['entrada','vitrine','garden','reuniao','garagem','cafe','gourmet','home-ambiente','recepcao','cinema','piscina','funcionarios'].includes(page)) {
            if (typeof initRoomPage === 'function') initRoomPage();
        }

        // Atualiza o bot√£o master na p√°gina de cen√°rios
        if (page === 'scenes') {
            initScenesPage();
        }
    }

    // Home: Master On/Off por ambiente (fun√ß√µes movidas para script.js)
    window.onHomeMasterClick = function(ev, btn){
        ev.stopPropagation();
        ev.preventDefault();
        
        // Verificar se j√° tem comando pendente
        if (btn.dataset.pending === 'true') {
            console.log('üö´ Comando master j√° em andamento');
            return;
        }
        
        const ids = (btn.dataset.deviceIds || '').split(',').filter(Boolean);
        if (!ids.length) return;
        
        const shouldTurnOn = !anyOn(ids);
        const cmd = shouldTurnOn ? 'on' : 'off';
        
        console.log(`üè† Master ${cmd} para ${ids.length} dispositivos:`, ids);
        
        // Marcar bot√£o como pendente
        btn.dataset.pending = 'true';
        
        // Atualizar visual imediatamente (for√ßar update)
        const img = btn.querySelector('img');
        if (img) {
            img.src = shouldTurnOn ? 'images/icons/icon-small-light-on.svg' : 'images/icons/icon-small-light-off.svg';
            btn.dataset.state = cmd;
        }
        
        // Proteger todos os dispositivos individuais para evitar conflitos
        ids.forEach(deviceId => {
            if (typeof protectDevice === 'function') {
                protectDevice(deviceId, 10000); // 10s de prote√ß√£o para master commands
            }
        });
        
        // Atualizar estados salvos imediatamente
        ids.forEach(id => {
            setStoredState(id, cmd);
        });
        
        // Atualizar UI imediatamente
        if (typeof updateStatesAfterMasterCommand === 'function') {
            updateStatesAfterMasterCommand(ids, cmd);
        }
        
        // Enviar comandos para todos os dispositivos
        const promises = ids.map(id => sendHubitatCommand(id, cmd));
        
        Promise.allSettled(promises).then(results => {
            const successes = results.filter(r => r.status === 'fulfilled').length;
            const failures = results.filter(r => r.status === 'rejected').length;
            
            console.log(`‚úÖ Master ${cmd}: ${successes} sucessos, ${failures} falhas`);
            
            // Segunda sincroniza√ß√£o ap√≥s comandos completos
            setTimeout(() => {
                if (typeof updateStatesAfterMasterCommand === 'function') {
                    updateStatesAfterMasterCommand(ids, cmd);
                }
            }, 300);
            
            // Remover prote√ß√£o ap√≥s delay
            setTimeout(() => {
                btn.dataset.pending = 'false';
                console.log(`üîì Master button liberado`);
            }, 3000);
            
        }).catch(error => {
            console.error('‚ùå Erro no comando master:', error);
            btn.dataset.pending = 'false';
        });
    };

    window.addEventListener('hashchange', renderSpa);
    window.addEventListener('DOMContentLoaded', () => {
        renderSpa();
        // Navbar SPA - listeners ap√≥s DOM pronto
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function(e) {
                const page = item.getAttribute('data-page');
                if (page) {
                    e.preventDefault();
                    spaNavigate(page);
                }
            });
        });
    });
    </script>
</body>
</html>
